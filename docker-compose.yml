version: "3.7"
services:
    piped:
          container_name: piped
              image: ghcr.io/team-piped/piped:latest
                  restart: unless-stopped
                      depends_on:
                              piped-db:
                                        condition: service_healthy
                                            ports:
                                                    - "${APP_PORT}:8080"
                                                        environment:
                                                                PORT: 8080
                                                                      DB_URL: "postgresql://${POSTGRES_USER:-tipi}:${POSTGRES_PASSWORD:-tipi}@piped-db:5432/${POSTGRES_DB:-piped}?sslmode=disable"
                                                                            PROXY_URL: "http://piped-proxy:8080"
                                                                                  BASE_URL: "https://${APP_DOMAIN}"
                                                                                      healthcheck:
                                                                                              test: ["CMD", "curl", "--fail", "http://localhost:8080/"]
                                                                                                    interval: 30s
                                                                                                          timeout: 5s
                                                                                                                retries: 2
                                                                                                                    networks:
                                                                                                                            - tipi_main_network
                                                                                                                                labels:
                                                                                                                                         Main
                                                                                                                                               traefik.enable: true
                                                                                                                                                     traefik.http.middlewares.piped-web-redirect.redirectscheme.scheme: https
                                                                                                                                                           traefik.http.services.piped.loadbalancer.server.port: 8080
                                                                                                                                                                 # Web
                                                                                                                                                                       traefik.http.routers.piped-insecure.rule: Host(`${APP_DOMAIN}`)
                                                                                                                                                                             traefik.http.routers.piped-insecure.entrypoints: web
                                                                                                                                                                                   traefik.http.routers.piped-insecure.service: piped
                                                                                                                                                                                         traefik.http.routers.piped-insecure.middlewares: piped-web-redirect
                                                                                                                                                                                               # Websecure
                                                                                                                                                                                                     traefik.http.routers.piped.rule: Host(`${APP_DOMAIN}`)
                                                                                                                                                                                                           traefik.http.routers.piped.entrypoints: websecure
                                                                                                                                                                                                                 traefik.http.routers.piped.service: piped
                                                                                                                                                                                                                       traefik.http.routers.piped.tls.certresolver: myresolver
                                                                                                                                                                                                                             # Local domain
                                                                                                                                                                                                                                   traefik.http.routers.piped-local-insecure.rule: Host(`piped.${LOCAL_DOMAIN}`)
                                                                                                                                                                                                                                         traefik.http.routers.piped-local-insecure.entrypoints: web
                                                                                                                                                                                                                                               traefik.http.routers.piped-local-insecure.service: piped
                                                                                                                                                                                                                                                     traefik.http.routers.piped-local-insecure.middlewares: piped-web-redirect
                                                                                                                                                                                                                                                           # Local domain secure
                                                                                                                                                                                                                                                                 traefik.http.routers.piped-local.rule: Host(`piped.${LOCAL_DOMAIN}`)
                                                                                                                                                                                                                                                                       traefik.http.routers.piped-local.entrypoints: websecure
                                                                                                                                                                                                                                                                             traefik.http.routers.piped-local.service: piped
                                                                                                                                                                                                                                                                                   traefik.http.routers.piped-local.tls: true
                                                                                                                                                                                                                                                                                         runtipi.managed: true
                                                                                                                                        
                                                                                                                                                                                                                                                                                           piped-proxy:
                                                                                                                                                                                                                                                                                               container_name: piped-proxy
                                                                                                                                                                                                                                                                                                   image: ghcr.io/team-piped/piped-proxy:latest
                                                                                                                                                                                                                                                                                                       restart: unless-stopped
                                                                                                                                                                                                                                                                                                           networks:
                                                                                                                                                                                                                                                                                                                 - tipi_main_network
                                                                                                                                                                                                                                                                                                                     labels:
                                                                                                                                                                                                                                                                                                                           runtipi.managed: true
                                                                                                                                        
                                                                                                                                                                                                                                                                                                                             piped-db:
                                                                                                                                                                                                                                                                                                                                 container_name: piped-db
                                                                                                                                                                                                                                                                                                                                     image: postgres:14
                                                                                                                                                                                                                                                                                                                                         restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                             volumes:
                                                                                                                                                                                                                                                                                                                                                   - ${APP_DATA_DIR}/data/postgres:/var/lib/postgresql/data
                                                                                                                                                                                                                                                                                                                                                       environment:
                                                                                                                                                                                                                                                                                                                                                             POSTGRES_DB: ${POSTGRES_DB:-piped}
                                                                                                                                                                                                                                                                                                                                                                   POSTGRES_USER: ${POSTGRES_USER:-tipi}
                                                                                                                                                                                                                                                                                                                                                                         POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-tipi}
                                                                                                                                                                                                                                                                                                                                                                             healthcheck:
                                                                                                                                                                                                                                                                                                                                                                                   test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
                                                                                                                                                                                                                                                                                                                                                                                       networks:
                                                                                                                                                                                                                                                                                                                                                                                             - tipi_main_network
                                                                                                                                                                                                                                                                                                                                                                                                 labels:
                                                                                                                                                                                                                                                                                                                                                                                                       runtipi.managed: true
